# Правила проекта: Telegram-бот OCR + PDF + Payments

## Суть проекта
Telegram-бот для студентов: приём изображений и многостраничных PDF, распознавание текста через LLM Vision (OpenRouter), выдача результата в чат (текст или файл .txt). Двойные сгораемые лимиты, оплата через ЮKassa, UTM-метки. Строгое соблюдение 152-ФЗ (согласие с политикой конфиденциальности при старте). Многопользовательская админка внутри Telegram для ассистентов (статистика, рассылки, управление балансами).

## Стек
- **Python**: 3.12+
- **Бот**: aiogram 3.x
- **БД**: PostgreSQL + SQLAlchemy 2.0 + asyncpg + Alembic
- **Очереди**: Celery + Redis
- **Оплата**: ЮKassa API (httpx)
- **Валидация**: Pydantic 2.x
- **PDF**: pypdf, pdf2image
- **OCR**: LLM Vision (OpenRouter, openai-совместимый API)

## Обязательные правила
- **Always check docs via Context7** перед использованием сторонних библиотек (API, БД).
- Все функции и публичные методы — с **docstrings** и **type hints**.
- Валидация входящих данных через **Pydantic** (конфиг, webhook payloads).
- Результат распознавания отдаётся в чат: текстом (до 4096 символов) или одним .txt файлом.
- Nginx: `client_max_body_size 50M`.
- Учитывать узкие места: лимиты Telegram API, экранирование, очереди, форматирование.

## Безопасность
- Никаких хардкод секретов; всё из `.env` / Pydantic Settings.
- SQL — только через ORM (SQLAlchemy), без сырых строк с подстановкой.
- Экранирование пользовательского ввода в сообщениях бота.

## Логирование и мониторинг
- Полное логирование: входящие апдейты (без персональных данных в логах), задачи Celery, ошибки.
- Структурированные логи (JSON или единый формат) для последующего мониторинга.
